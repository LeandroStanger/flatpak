From: Alexander Larsson <alexl@redhat.com>
Date: Mon, 19 Jun 2017 15:01:19 +0200
Subject: Manually copy summary for update and appdata too

Origin: backport, 0.9.6, commit:67ffd9a0b6f2f76de8aa08e6eb00505e48c48cbd
Forwarded: https://github.com/flatpak/flatpak/pull/874
Applied-upstream: 0.8.8, commit:0723efdcc8f960cadf6d9235f0e93e715f287fd0
---
 common/flatpak-dir.c | 46 ++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 46 insertions(+)

diff --git a/common/flatpak-dir.c b/common/flatpak-dir.c
index 83c0f1b..4f6f54d 100644
--- a/common/flatpak-dir.c
+++ b/common/flatpak-dir.c
@@ -1652,6 +1652,10 @@ flatpak_dir_update_appstream (FlatpakDir          *self,
       g_autoptr(OstreeRepo) child_repo = NULL;
       g_auto(GLnxLockFile) child_repo_lock = GLNX_LOCK_FILE_INIT;
       FlatpakSystemHelper *system_helper;
+      g_autoptr(GBytes) summary_copy = NULL;
+      g_autoptr(GBytes) summary_sig_copy = NULL;
+      g_autoptr(GFile) summary_file = NULL;
+      g_autoptr(GFile) summary_sig_file = NULL;
 
       child_repo = flatpak_dir_create_system_child_repo (self, &child_repo_lock, error);
       if (child_repo == NULL)
@@ -1661,11 +1665,30 @@ flatpak_dir_update_appstream (FlatpakDir          *self,
 
       g_assert (system_helper != NULL);
 
+      if (!flatpak_dir_remote_fetch_summary (self, remote,
+                                             &summary_copy, &summary_sig_copy,
+                                             cancellable, error))
+        return FALSE;
+
       if (!flatpak_dir_pull (self, remote, branch, NULL, NULL,
                              child_repo, FLATPAK_PULL_FLAGS_NONE, OSTREE_REPO_PULL_FLAGS_MIRROR,
                              progress, cancellable, error))
         return FALSE;
 
+      summary_file = g_file_get_child (ostree_repo_get_path (child_repo), "summary");
+      if (!g_file_replace_contents (summary_file,
+                                    g_bytes_get_data (summary_copy, NULL),
+                                    g_bytes_get_size (summary_copy),
+                                    NULL, FALSE, 0, NULL, cancellable, NULL))
+        return FALSE;
+
+      summary_sig_file = g_file_get_child (ostree_repo_get_path (child_repo), "summary.sig");
+      if (!g_file_replace_contents (summary_sig_file,
+                                    g_bytes_get_data (summary_sig_copy, NULL),
+                                    g_bytes_get_size (summary_sig_copy),
+                                    NULL, FALSE, 0, NULL, cancellable, NULL))
+        return FALSE;
+
       if (!ostree_repo_resolve_rev (child_repo, branch, TRUE, &new_checksum, error))
         return FALSE;
 
@@ -4979,6 +5002,10 @@ flatpak_dir_update (FlatpakDir          *self,
              user and hand back the resulting data to the system-helper, that trusts us
              due to the GPG signatures in the repo */
           FlatpakPullFlags flatpak_flags;
+          g_autoptr(GBytes) summary_copy = NULL;
+          g_autoptr(GBytes) summary_sig_copy = NULL;
+          g_autoptr(GFile) summary_file = NULL;
+          g_autoptr(GFile) summary_sig_file = NULL;
 
           child_repo = flatpak_dir_create_system_child_repo (self, &child_repo_lock, error);
           if (child_repo == NULL)
@@ -4988,12 +5015,31 @@ flatpak_dir_update (FlatpakDir          *self,
           if (checksum_or_latest != NULL)
             flatpak_flags |= FLATPAK_PULL_FLAGS_ALLOW_DOWNGRADE;
 
+          if (!flatpak_dir_remote_fetch_summary (self, remote_name,
+                                                 &summary_copy, &summary_sig_copy,
+                                                 cancellable, error))
+            return FALSE;
+
           if (!flatpak_dir_pull (self, remote_name, ref, rev, subpaths,
                                  child_repo,
                                  flatpak_flags, OSTREE_REPO_PULL_FLAGS_MIRROR,
                                  progress, cancellable, error))
             return FALSE;
 
+          summary_file = g_file_get_child (ostree_repo_get_path (child_repo), "summary");
+          if (!g_file_replace_contents (summary_file,
+                                        g_bytes_get_data (summary_copy, NULL),
+                                        g_bytes_get_size (summary_copy),
+                                        NULL, FALSE, 0, NULL, cancellable, NULL))
+            return FALSE;
+
+          summary_sig_file = g_file_get_child (ostree_repo_get_path (child_repo), "summary.sig");
+          if (!g_file_replace_contents (summary_sig_file,
+                                        g_bytes_get_data (summary_sig_copy, NULL),
+                                        g_bytes_get_size (summary_sig_copy),
+                                        NULL, FALSE, 0, NULL, cancellable, NULL))
+            return FALSE;
+
           if (!ostree_repo_resolve_rev (child_repo, ref, FALSE, &latest_checksum, error))
             return FALSE;
 
