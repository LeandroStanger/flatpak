From: Simon McVittie <smcv@debian.org>
Date: Mon, 23 May 2016 20:38:51 +0100
Subject: Skip tests that make a repository if /var/tmp lacks user xattrs

Signed-off-by: Simon McVittie <smcv@debian.org>
---
 tests/libtest.sh      | 8 ++++++++
 tests/test-builder.sh | 1 +
 tests/test-run.sh     | 1 +
 3 files changed, 10 insertions(+)

diff --git a/tests/libtest.sh b/tests/libtest.sh
index 17831bf..f074827 100644
--- a/tests/libtest.sh
+++ b/tests/libtest.sh
@@ -196,6 +196,14 @@ run_sh () {
     ${CMD_PREFIX} flatpak run --command=bash ${ARGS-} org.test.Hello -c "$*"
 }
 
+skip_without_user_xattrs () {
+    touch test-xattrs
+    if ! setfattr -n user.testvalue -v somevalue test-xattrs; then
+        echo "1..0 # SKIP this test requires xattr support"
+        exit 0
+    fi
+}
+
 skip_without_bwrap () {
     if [ -z "${FLATPAK_BWRAP:-}" ]; then
         # running installed-tests: assume we know what we're doing
diff --git a/tests/test-builder.sh b/tests/test-builder.sh
index f4b19be..0809f43 100755
--- a/tests/test-builder.sh
+++ b/tests/test-builder.sh
@@ -22,6 +22,7 @@ set -euo pipefail
 . $(dirname $0)/libtest.sh
 
 skip_without_bwrap
+skip_without_user_xattrs
 
 echo "1..3"
 
diff --git a/tests/test-run.sh b/tests/test-run.sh
index 4f3dc44..f9b67a6 100755
--- a/tests/test-run.sh
+++ b/tests/test-run.sh
@@ -22,6 +22,7 @@ set -euo pipefail
 . $(dirname $0)/libtest.sh
 
 skip_without_bwrap
+skip_without_user_xattrs
 
 echo "1..7"
 
